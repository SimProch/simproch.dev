import { c as create_ssr_component, e as escape } from "./ssr.js";
import { C as Contents } from "./11-system-design-news-feed2.js";
const _11_system_design_news_feed = create_ssr_component(($$result, $$props, $$bindings, slots) => {
  const contents = Contents;
  if ($$props.contents === void 0 && $$bindings.contents && contents !== void 0)
    $$bindings.contents(contents);
  return `<h1>${escape(Contents.title)}</h1> <p>${escape(contents.subtitle)}</p> <h2 data-svelte-h="svelte-1j1kxdd"><a href="#intro">Introduction</a><span id="intro"></span></h2> <p data-svelte-h="svelte-16c4pc6">Congratulations on making it this far! This time, we’ll go back in time a little.</p> <p data-svelte-h="svelte-70rq1e">In the <a href="/posts/3-system-design-estimations#high-level-design">third</a> section, we’ve already talked about a basic news feed.</p> <p data-svelte-h="svelte-p43cka">Let’s try to revisit that this time once again with what we’ve learned!</p> <h2 data-svelte-h="svelte-1o8l1z3"><a href="#scope">Scope</a><span id="scope"></span></h2> <p data-svelte-h="svelte-197b2bz">A news feed publishing, similar to facebook timeline page.</p> <ul data-svelte-h="svelte-3d7mj5"><li>Mobile &amp; Web app</li> <li>10 millions daily active users</li> <li>Can contain text, images and videos simultaneously</li> <li>The important feature is that user can make a post and see posts of their friends</li> <li>A user can have 5000 friends</li> <li>Posts are visible in reverse chronological order</li> <li>App is available worldwide</li></ul> <h2 data-svelte-h="svelte-7hgrrf"><a href="#high-level-design">High Level Design</a><span id="high-level-design"></span></h2> <p data-svelte-h="svelte-j45dnr">So, again, let’s start with a high level design! We’ll have a bunch of services here!</p> <p data-svelte-h="svelte-1bwns6r">It makes sense to start with <strong>publishing service</strong> since there would be no posts to retrieve without one!
An HTTP call to this service could be something like <code>POST api/feed/create</code>. This would require authentication
and content.</p> <p data-svelte-h="svelte-18xcdu7">Then, a <strong>news feed service</strong> which retrieves the posts. This could look like <code>GET api/feed/me</code> to receive
data curated for the user who requests it. Again, auth token is required.</p> <p data-svelte-h="svelte-19ly9la">Now, since the two services are separate, how will the <strong>news feed service</strong> know about new posts? Well, the
<strong>publishing</strong> service needs to handle that as well. Once a post is created, it’s saved into a database/cache of
<strong>news feed service</strong>.</p> <p data-svelte-h="svelte-8xtv6m">Now, that looks a little weird, right? The two services communicating weirdly. One for retrieving posts, while another one for saving them?</p> <p data-svelte-h="svelte-1v4vey">So, let’s redefine them!</p> <ul data-svelte-h="svelte-f63i9j"><li>Post service, which contains all posts that have been posted, and has a cache and DB of posts</li> <li>News feed service, which is responsible for creating and retrieving them</li></ul> <p data-svelte-h="svelte-1mxkiyd">Now, when a new post is created, it gets created in news feed service and saved in post DB.</p> <p data-svelte-h="svelte-flxtu0">Finally, we’ve discussed notifications last time. Let’s add a notification service in here as we know how to do it!
Users can now be notified of new content!</p> <p data-svelte-h="svelte-w7ta3b">Now, as usual, this looks like a distributed system. So, we’ll need:</p> <ul data-svelte-h="svelte-1bvkq6r"><li>Load balancers for multiple servers</li> <li>Rate limiting to not be overwhelmed</li> <li>Authentication as we’ve mentioned we are using it</li> <li>Monitoring and analytics</li></ul> <p data-svelte-h="svelte-1xm03mj">Finally, we also want to store the information somewhere. That’d again be database and cache for fast retrieval.
Note that the list is in reverse chronological order, so we could cache the latest published posts.</p> <h2 data-svelte-h="svelte-fyvevz"><a href="#deep-dive">Deep dive into design</a><span id="deep-dive"></span></h2> <p data-svelte-h="svelte-hdd0ow">So, let’s identify the problematic parts.</p> <ul data-svelte-h="svelte-wb84tr"><li>Post service is just for storing the posts</li> <li>Notification service is just for pushing notifications</li> <li>The most work here is done by the news feed itself. Why?<ul><li>Creates the posts and saves them to <strong>post service</strong></li> <li>Furthermore, it creates the feed for friends list</li> <li>And because it creates the feed for all friends, it also pushes the post to <strong>notification service</strong></li></ul></li></ul> <p data-svelte-h="svelte-1t0jt14">So, the first 2 don’t need much more attention, but we can get better in the <strong>news feed service</strong>. Let’s try to improve</p> <p data-svelte-h="svelte-1mt1ic1">When a post is created, it is saved into <strong>post service</strong>. However, we also want to build the news feed for friends.</p> <p data-svelte-h="svelte-86b499">A social network is basically a graph, where nodes are users and edges are their relationships. There’s also a
<a href="https://en.wikipedia.org/wiki/Graph_database" rel="nofollow">Graph DB</a> that’s good for these use cases. So, for getting the
relations, we’ll use GDB.</p> <p data-svelte-h="svelte-57quii">After we’ve fetched all the users to which we want to save the newly published post, we need to get their data.
This will most likely be a user DB.</p> <p data-svelte-h="svelte-y2c9wn">Finally, we will be pushing the latest posts into the cache. Now, pushing 1 post into 5000 friends can be slow.
It gets even slower when we have a lot of users. Therefore, for publishing, we’ll use a message queue and multiple
workers to handle that.</p> <p data-svelte-h="svelte-7644ns">Lastly, this entire process is called <a href="https://en.wikipedia.org/wiki/Fan-out_(software)" rel="nofollow">Fanout</a>. We’re basically
delivering a message to all friends.</p> <p data-svelte-h="svelte-8ncvz3">Now, there’s a potential problem in here. Imagine the following scenario:</p> <ul data-svelte-h="svelte-f9j08a"><li>A user has 5000 friends</li> <li>80 % of these users are inactive</li> <li>We’re effectivelly pushing every post to users that won’t read it.</li></ul> <p data-svelte-h="svelte-1v4ou7x">So, we have essentially 2 options:</p> <p data-svelte-h="svelte-17m8dl3"><strong>Fanout on write</strong> is where the above problem happens. The news feed is in real time and fetching it is fast
because it is precomputed. However, if there are many friends, the generation can be slow, especially if there
are inactive users.</p> <p data-svelte-h="svelte-1f7g9f"><strong>Fanout on read</strong> is the opposite. The fanout basically happens when the data is read, meaning that it is
on demand. For inactive users, resources are not wasted. However, fetching the news feed may be slow as it’s not
precomputed.</p> <p data-svelte-h="svelte-1w01ct5">Again, it depends on the use case. We could even adopt a hybrid approach:</p> <ul data-svelte-h="svelte-k7811p"><li>Users that have many followers will have content on demand</li> <li>Users with less followers will have real-time content</li></ul> <h3 data-svelte-h="svelte-1untqvm"><a href="#caching">Caching</a><span id="caching"></span></h3> <p data-svelte-h="svelte-1412i3s">Now, one of the most important part here is caching. There can be a lot of posts, historical or new, and a lot of friends.</p> <p data-svelte-h="svelte-1ntrhmr">We can have cache for the following:</p> <ul data-svelte-h="svelte-tuu2pt"><li>News feed - a cache of IDs <code>userId, postId</code></li> <li>Content - Stores all post data. Popular content is stored in separate <a href="https://stackoverflow.com/questions/22756092/what-does-it-mean-by-cold-cache-and-warm-cache-concept" rel="nofollow">hot cache</a></li> <li>Social Graph - Stores relations between users (follower/following)</li> <li>Actions - Stores info about interactions (likes, replies, shares, …)</li> <li>Counters - Like counter for example. We don’t need to show all likes immediately, only counters.</li></ul> <p data-svelte-h="svelte-1z0kqqi">Our final system could look like:</p> <img src="/images/system-design/deep-dive-post-publishing.webp" alt="Deep Dive Post Publishing" title="Deep Dive Post Publishing" class="image" loading="lazy"> <h2 data-svelte-h="svelte-1gat2or"><a href="#summary">Summary</a><span id="summary"></span></h2> <p data-svelte-h="svelte-y20khu">In this part, we’ve revisited a previous friend - news feed service.</p> <p data-svelte-h="svelte-1ojpi94">We’ve again taken a look at the original design, but described the concepts a little more and enhanced it.</p> <p data-svelte-h="svelte-18rvrs2">Hopefully this trip down the memory lane was useful for you - it certainly was for me!</p> <h1 data-svelte-h="svelte-uqufyh"><a href="#references">References</a><span id="references"></span></h1> <ul data-svelte-h="svelte-p0zeup"><li><a href="https://www.amazon.com/System-Design-Interview-insiders-Second/dp/B08CMF2CQF" rel="nofollow">System Design Interview book</a></li> <li><a href="https://en.wikipedia.org/wiki/Graph_database" rel="nofollow">Graph DB</a></li> <li><a href="https://en.wikipedia.org/wiki/Fan-out_(software)" rel="nofollow">Fanout</a></li> <li><a href="https://stackoverflow.com/questions/22756092/what-does-it-mean-by-cold-cache-and-warm-cache-concept" rel="nofollow">Hot vs Cold cache</a></li></ul>`;
});
export {
  _11_system_design_news_feed as default
};
